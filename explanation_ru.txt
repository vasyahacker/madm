Что делает madm
===============

При первом запуске проверяет наличие своей sqlite бд и если ее нет, предлагает настроить почтовик с нуля: ставит необходимые пакеты (аддоны к opesmtpd, dovecot, rspamd, redis, sqlite3) создает бд, конфиги и настраивает первый почтовый домен.
Создает файл /etc/mail/check_quota.sh (проверка переполненных ящиков) и настраивает запуск его по крону раз в 5 мин. это необходимо по сколько opensmtpd не умеет обрабатывать сообщение оверквоты от imap сервера по lmtp
Тюнит /etc/login.conf (добавляет лимиты для пользователя dovecot)
Добавляет пользователя vmail
Создает дополнительные скрипты для dovecot:
/usr/local/lib/dovecot/sieve/sa-learn-{spam,ham}.sh
/etc/dovecot/quota-warning.sh

opensmtpd
---------
- Сертификаты берет/хранит в /etc/ssl/private/$HOSTNAME.{key,fullchain.pem}
Домены, адреса, хеши паролей, алиасы, квоты хранятся в /etc/mail/mail_db.sqlite
- Пароли хешируются BLF-CRYPT
- Информация о переполненных ящиках берется из /etc/mail/fullboxes
- Фильтрует спам и подписывает(dkim) письма через rspamd
- Складывает входящую почту в dovecot через lmtp

dovecot
-------
- Работает с тойже бд (/etc/mail/mail_db.sqlite), пользователи/пароли теже
- Отвечает за квоты и рассылает пользователям предупреждения (скриптом /etc/dovecot/quota-warning.sh) начиная с 80% заполненности ящика и перестает принимать почту когда ящик заполнен на 100% + 100Mb
- Сертификаты те же/там же что и у opensmtpd + /etc/ssl/dovecot/dh.pem
- Держит связь с opensmtpd через lmtp
- Обучает rspamd посредством /usr/local/lib/dovecot/sieve/sa-learn-{spam,ham}.sh когда пользователь переносит письма в imap-папку спама(Junk) и обратно. (ВОЗМОЖНО РАБОТАЕТ НЕ СОВСЕМ КОРРЕКТНО ИЗ-ЗА ШИФРОВАНИЯ, НЕ ЗНАЮ КАК ПРОВЕРИТЬ)
- Шифрует почту открытым ключом по алгоритму secp521r1 который в качестве пароля использует sha512 от пароля (не хеша), который получает во время авторизации по imap. Пароль нужен только для расшифровки закрытого ключа для просмотра шифрованной почты, а зашифровка происходит при получении автоматом во время получения (открытым ключом). Ключи у каждого пользователя свои, хранятся в /var/vmail/ДОМЕН/ПОЛЬЗОВАТЕЛЬ/Maildir/dovecot-attributes

rspamd
------
Конфиги дефолтные/не меняются
Ключи (которые генерятся madm при создании домена) для подписи писем, автоматом подхватывает тут: /var/rspamd/dkim/${domain}.{dkim.key,pub}

imapsync (опционально)
----------------------
Вызывается из меню help для копирования всей почты по imap с gmail (можно донастроить на любой другой почтовик)
Для переноса спрашивает логины/пароли gmail и от локального ящика
